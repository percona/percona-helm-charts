apiVersion: batch/v1
kind: Job
metadata:
  name: pre-delete-check-pg-clusters
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": "pre-delete"
    "helm.sh/hook-weight": "-1" # Run this hook early
    "helm.sh/hook-delete-policy": "before-hook-creation,hook-succeeded"
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: check-clusters
        image: "alpine:3.18" # Alpine base image with kubectl installed
        command:
          - /bin/sh
          - -c
        args:
          - |
            echo "Installing kubectl..."
            apk add --no-cache curl
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            mv kubectl /usr/local/bin/
            
            echo "Checking for running PostgreSQL clusters before deleting the operator..."
            
            while true; do
              pg_clusters=$(kubectl get pg -n {{ .Release.Namespace }} -o jsonpath='{.items[*].metadata.name}' 2>/dev/null)
              
              if [ -z "$pg_clusters" ]; then
                echo "✅ No running PostgreSQL clusters found. Proceeding with operator deletion."
                sleep 30
                break
              else
                echo "⏳ Still found running PostgreSQL clusters: $pg_clusters"
                echo "Sleeping for 5 seconds before checking again..."
                sleep 1
              fi
            done
            
            exit 0
