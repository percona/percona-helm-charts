apiVersion: v1
kind: ConfigMap
metadata:
  name: pmm-ha-haproxy-init-script
  namespace: {{ .Release.Namespace }}
data:
  wait-for-pmm.sh: |
    set -euo pipefail
    
    echo "HAProxy init: Waiting for PMM instances to be ready..."
    echo "Current namespace: {{ .Release.Namespace }}"
    echo "Expected PMM replicas: {{ .Values.replicas }}"
    
    apk add --no-cache curl > /dev/null 2>&1
    
    check_pmm_ready() {
      local pmm_host="$1"
      local pmm_port="$2"
      local timeout="${3:-10}"
      
      echo "Checking PMM instance: $pmm_host:$pmm_port"
      
      if curl -s --max-time "$timeout" --fail "http://$pmm_host:$pmm_port/v1/readyz" > /dev/null 2>&1; then
        echo "‚úÖ HTTP health check passed for $pmm_host:$pmm_port"
        return 0
      elif curl -s --max-time "$timeout" --fail -k "https://$pmm_host:$pmm_port/v1/readyz" > /dev/null 2>&1; then
        echo "‚úÖ HTTPS health check passed for $pmm_host:$pmm_port"
        return 0
      else
        echo "‚ùå Health check failed for $pmm_host:$pmm_port"
        return 1
      fi
    }
    
    max_attempts=60
    attempt=1
    
    while [ $attempt -le $max_attempts ]; do
      echo "Attempt $attempt/$max_attempts: Checking PMM instances..."
      
      all_ready=true
      ready_count=0
      
      for i in $(seq 0 $(({{ .Values.replicas }} - 1))); do
        pmm_host="{{ .Release.Name }}-$i.{{ .Values.service.name | default "monitoring-service" }}.{{ .Release.Namespace }}.svc.cluster.local"
        
        if check_pmm_ready "$pmm_host" "8080" 5; then
          ready_count=$((ready_count + 1))
          echo "‚úÖ Instance $i is ready ($ready_count/{{ .Values.replicas }})"
        else
          echo "‚ùå Instance $i is not ready yet"
          all_ready=false
        fi
      done
      
      echo "Ready instances: $ready_count/{{ .Values.replicas }}"
      
      if [ "$all_ready" = true ]; then
        echo "üéâ All PMM instances are ready! HAProxy can now start."
        exit 0
      fi
      
      echo "‚è≥ Not all PMM instances are ready yet. Waiting 5 seconds..."
      sleep 5
      attempt=$((attempt + 1))
    done
    
    echo "‚ùå Timeout: PMM instances did not become ready within 5 minutes"
    echo "This may indicate an issue with PMM deployment"
    exit 1
