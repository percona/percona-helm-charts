apiVersion: "clickhouse.altinity.com/v1"
kind: ClickHouseInstallation
metadata:
  name: {{ .Release.Name }}
spec:
  configuration:
    # ClickHouse Keeper coordination
    zookeeper:
      nodes:
        - host: chk-{{ .Release.Name }}-keeper-nodes-0-0.{{ .Release.Namespace }}.svc.cluster.local
          port: 2181
        - host: chk-{{ .Release.Name }}-keeper-nodes-0-1.{{ .Release.Namespace }}.svc.cluster.local
          port: 2181
        - host: chk-{{ .Release.Name }}-keeper-nodes-0-2.{{ .Release.Namespace }}.svc.cluster.local
          port: 2181
      session_timeout_ms: 30000
      operation_timeout_ms: 10000
    
    clusters:
      - name: {{ .Values.clickhouse.cluster.name }}
        templates:
          podTemplate: clickhouse-pod-template
        layout:
          shardsCount: {{ .Values.clickhouse.cluster.shards }}
          replicasCount: {{ .Values.clickhouse.cluster.replicas }}
    
    # Prometheus metrics configuration
    settings:
      prometheus/port: "9363"
      prometheus/endpoint: "/metrics"
      prometheus/metrics: "true"
      prometheus/events: "true"
      prometheus/asynchronous_metrics: "true"
    
    # Profiles configuration
    profiles:
      clickhouse_operator/allow_experimental_analyzer: "0"
      clickhouse_operator/prefer_localhost_replica: "1"
      readonly/readonly: "2"
    
    # User management - provision secure default users
    users:
      # Admin user for operator management
      clickhouse_operator/access_management: "1"
      clickhouse_operator/named_collection_control: "1"
      clickhouse_operator/networks/ip:
        - 127.0.0.1
        - 10.0.0.0/8
        - 172.16.0.0/12
        - 192.168.0.0/16
      clickhouse_operator/profile: clickhouse_operator
      clickhouse_operator/quota: default
      clickhouse_operator/show_named_collections: "1"
      clickhouse_operator/show_named_collections_secrets: "1"
      
      # PMM application user (chuser)
      {{ .Values.clickhouse.users.chuser.name }}/password_sha256_hex: "{{ .Values.clickhouse.users.chuser.password_sha256_hex }}"
      {{ .Values.clickhouse.users.chuser.name }}/networks/ip:
        {{- range .Values.clickhouse.users.chuser.networks.ip }}
        - {{ . }}
        {{- end }}
      {{ .Values.clickhouse.users.chuser.name }}/profile: default
      {{ .Values.clickhouse.users.chuser.name }}/quota: default
      {{ .Values.clickhouse.users.chuser.name }}/access_management: "1"
    
    # Disable default user completely via XML override
    files:
      users.d/disable-default-user.xml: |
        <clickhouse>
          <users>
            <default remove="1"/>
          </users>
        </clickhouse>

  templates:
    podTemplates:
      - name: clickhouse-pod-template
        generateName: "{{ .Release.Name }}-{cluster}-{shard}-{replica}"
        metadata:
          annotations:
            prometheus.io/scrape: "true"
            prometheus.io/port: "9363"
            prometheus.io/path: "/metrics"
        spec:
          # Pod anti-affinity to spread replicas across different nodes
          affinity:
            podAntiAffinity:
              preferredDuringSchedulingIgnoredDuringExecution:
                - weight: 100
                  podAffinityTerm:
                    labelSelector:
                      matchLabels:
                        clickhouse.altinity.com/chi: {{ .Release.Name }}-clickhouse
                    topologyKey: kubernetes.io/hostname
          containers:
            - name: clickhouse
              image: altinity/clickhouse-server:25.3.6.10034.altinitystable-alpine # Use a stable image
              ports:
                - name: metrics
                  containerPort: 9363
                  protocol: TCP
              resources:
                requests:
                  memory: "1Gi"
                  cpu: "500m"
                limits:
                  memory: "4Gi"
                  cpu: "2"

