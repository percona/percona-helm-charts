{{- $secret := (lookup "v1" "Secret" .Release.Namespace .Values.secret.name) }}
{{- $clickhouseUser := "clickhouse_pmm" }}
{{- if $secret }}
{{- $clickhouseUser = (index $secret.data "PMM_CLICKHOUSE_USER" | b64dec) }}
{{- else if .Values.secret.clickhouse_user }}
{{- $clickhouseUser = .Values.secret.clickhouse_user }}
{{- end }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-clickhouse-init
  labels:
    app.kubernetes.io/name: {{ include "pmm.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: clickhouse-init
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  backoffLimit: 10
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "pmm.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/component: clickhouse-init
    spec:
      restartPolicy: OnFailure
      containers:
        - name: clickhouse-init
          image: {{ .Values.clickhouse.image.repository }}:{{ .Values.clickhouse.image.tag }}
          imagePullPolicy: {{ .Values.clickhouse.image.pullPolicy }}
          command:
            - /bin/bash
            - -c
            - |
              set -e
              
              # Debug: Check if password is available
              if [ -z "${PMM_CLICKHOUSE_PASSWORD}" ]; then
                echo "✗ ERROR: PMM_CLICKHOUSE_PASSWORD environment variable is not set"
                exit 1
              fi
              
              echo "✓ Password environment variable is set (length: ${#PMM_CLICKHOUSE_PASSWORD})"
              
              CLUSTER_NAME="{{ .Values.clickhouse.cluster.name }}"
              EXPECTED_REPLICAS={{ .Values.clickhouse.cluster.replicas }}
              CH_USER="{{ $clickhouseUser }}"
              CHI_NAME="{{ .Release.Name }}"
              
              # Altinity operator creates services with pattern: clickhouse-{CHI_NAME}
              SERVICE_HOST="clickhouse-${CHI_NAME}"
              
              echo "=== ClickHouse Cluster Initialization ==="
              echo "Cluster name: ${CLUSTER_NAME}"
              echo "Expected replicas: ${EXPECTED_REPLICAS}"
              echo "CHI name: ${CHI_NAME}"
              echo "Service host: ${SERVICE_HOST}"
              echo "ClickHouse user: ${CH_USER}"
              echo "=========================================="
              
              # Test basic connectivity (headless service may not resolve via nslookup)
              echo "Testing ClickHouse connectivity..."
              for i in {1..60}; do
                if clickhouse-client --host "${SERVICE_HOST}" \
                  --user "${CH_USER}" --password "${PMM_CLICKHOUSE_PASSWORD}" \
                  --query "SELECT version()" 2>&1; then
                  echo "✓ Connected to ClickHouse successfully"
                  break
                fi
                echo "Waiting for ClickHouse to be available... (attempt ${i}/60)"
                sleep 5
              done
              
              # Wait for the ClickHouse cluster to form
              echo "Waiting for cluster to form..."
              for i in {1..120}; do
                # Try to get replica count, show errors for debugging
                QUERY_OUTPUT=$(clickhouse-client --host "${SERVICE_HOST}" \
                  --user "${CH_USER}" --password "${PMM_CLICKHOUSE_PASSWORD}" \
                  --query "SELECT count() FROM system.clusters WHERE cluster='${CLUSTER_NAME}'" 2>&1)
                
                REPLICA_COUNT=$(echo "${QUERY_OUTPUT}" | tail -1 | grep -E '^[0-9]+$' || echo 0)
                
                if [ "$REPLICA_COUNT" -eq "$EXPECTED_REPLICAS" ]; then
                  echo "✓ Cluster formed with ${REPLICA_COUNT} replicas"
                  break
                fi
                
                if [ $((i % 10)) -eq 0 ]; then
                  echo "DEBUG: Query output: ${QUERY_OUTPUT}"
                fi
                
                echo "Waiting for cluster to form... (${REPLICA_COUNT}/${EXPECTED_REPLICAS} replicas visible, attempt ${i}/120)"
                sleep 5
              done
              
              # Verify cluster is ready
              FINAL_COUNT=$(clickhouse-client --host "${SERVICE_HOST}" \
                --user "${CH_USER}" --password "${PMM_CLICKHOUSE_PASSWORD}" \
                --query "SELECT count() FROM system.clusters WHERE cluster='${CLUSTER_NAME}'" 2>/dev/null || echo 0)
              
              if [ "$FINAL_COUNT" -ne "$EXPECTED_REPLICAS" ]; then
                echo "✗ Failed to form complete cluster. Found ${FINAL_COUNT}/${EXPECTED_REPLICAS} replicas"
                echo "Available clusters:"
                clickhouse-client --host "${SERVICE_HOST}" \
                  --user "${CH_USER}" --password "${PMM_CLICKHOUSE_PASSWORD}" \
                  --query "SELECT cluster, count() as replicas FROM system.clusters GROUP BY cluster"
                exit 1
              fi
              
              # Create database on cluster
              echo "Creating database 'pmm' on cluster '${CLUSTER_NAME}'..."
              clickhouse-client --host "${SERVICE_HOST}" \
                --user "${CH_USER}" --password "${PMM_CLICKHOUSE_PASSWORD}" \
                --query "CREATE DATABASE IF NOT EXISTS pmm ON CLUSTER '${CLUSTER_NAME}'"
              
              echo "✓ Database 'pmm' created successfully on all replicas"
          env:
            - name: PMM_CLICKHOUSE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.secret.name }}
                  key: PMM_CLICKHOUSE_PASSWORD
