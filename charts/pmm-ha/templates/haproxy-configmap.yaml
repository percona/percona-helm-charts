apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-haproxy
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: haproxy
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
data:
  haproxy.cfg: |
    global
        log stdout    local0 debug
        log stdout    local1 info
        log stdout    local2 info
        daemon
    
    defaults
        log     global
        mode    http
        option  httplog
        option  dontlognull
        timeout connect 5000
        timeout client  50000
        timeout server  50000
    
    frontend http_front
        bind *:80
        default_backend http_back    
    
    frontend https_front
        bind *:443 ssl crt /etc/haproxy/certs/pmm.pem
        default_backend https_back

    backend http_back
        option httpchk
        http-check send meth GET uri /v1/server/leaderHealthCheck ver HTTP/1.1 hdr Host www
        http-check expect status 200
        {{- range $i := until (int .Values.replicas) }}
        {{- if eq $i 0 }}
        server pmm-server-active-http  {{ $.Release.Name }}-{{ $i }}.monitoring-service.{{ $.Release.Namespace }}.svc.cluster.local:8080 check
        {{- else }}
        server pmm-server-passive-{{ $i }}-http {{ $.Release.Name }}-{{ $i }}.monitoring-service.{{ $.Release.Namespace }}.svc.cluster.local:8080 check backup
        {{- end }}
        {{- end }}

    backend https_back
        option httpchk
        http-check send meth GET uri /v1/server/leaderHealthCheck ver HTTP/1.1 hdr Host www
        http-check expect status 200
        {{- range $i := until (int .Values.replicas) }}
        {{- if eq $i 0 }}
        server pmm-server-active-https {{ $.Release.Name }}-{{ $i }}.monitoring-service.{{ $.Release.Namespace }}.svc.cluster.local:8443 check ssl verify none
        {{- else }}
        server pmm-server-passive-{{ $i }}-https {{ $.Release.Name }}-{{ $i }}.monitoring-service.{{ $.Release.Namespace }}.svc.cluster.local:8443 check ssl verify none
        {{- end }}
        {{- end }}
