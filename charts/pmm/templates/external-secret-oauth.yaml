{{- if and .Values.externalSecrets.enabled .Values.externalSecrets.oauth.enabled }}
{{- if not .Values.externalSecrets.oauth.secretStoreRef.name }}
{{- fail "externalSecrets.oauth.secretStoreRef.name is required when externalSecrets.oauth.enabled is true" }}
{{- end }}
{{- if not .Values.externalSecrets.oauth.data }}
{{- fail "externalSecrets.oauth.data is required when externalSecrets.oauth.enabled is true" }}
{{- end }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ .Values.externalSecrets.oauth.name | default (printf "%s-oauth-external-secret" (include "pmm.fullname" .)) }}
  namespace: {{ include "pmm.namespace" . }}
  labels:
    {{- include "pmm.labels" . | nindent 4 }}
    {{- if .Values.extraLabels }}
    {{- toYaml .Values.extraLabels | nindent 4 }}
    {{- end }}
    {{- if .Values.externalSecrets.oauth.labels }}
    {{- toYaml .Values.externalSecrets.oauth.labels | nindent 4 }}
    {{- end }}
  {{- if .Values.externalSecrets.oauth.annotations }}
  annotations:
    {{- toYaml .Values.externalSecrets.oauth.annotations | nindent 4 }}
  {{- end }}
spec:
  secretStoreRef:
    name: {{ .Values.externalSecrets.oauth.secretStoreRef.name }}
    kind: {{ .Values.externalSecrets.oauth.secretStoreRef.kind | default "SecretStore" }}
  refreshInterval: {{ .Values.externalSecrets.oauth.refreshInterval | default "5m" }}
  target:
    name: {{ .Values.externalSecrets.oauth.targetSecretName | default (printf "%s-oauth" (include "pmm.fullname" .)) }}
    creationPolicy: Owner
    deletionPolicy: Retain
  data:
    {{- toYaml .Values.externalSecrets.oauth.data | nindent 4 }}
{{- end }}
