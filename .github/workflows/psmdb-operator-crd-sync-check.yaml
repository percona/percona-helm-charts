name: PSMDB Operator CRD Sync Check

on:
  pull_request:
    paths:
      - 'charts/psmdb-operator/**'
      - 'charts/psmdb-operator-crds/**'
  push:
    branches:
      - main
    paths:
      - 'charts/psmdb-operator/**'
      - 'charts/psmdb-operator-crds/**'

jobs:
  check-crd-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check CRD sync
        run: |
          set -e
          
          echo "Checking if CRD files are in sync..."
          echo ""
          
          # Combine CRD templates into a single file
          TEMP_COMBINED=$(mktemp)
          for crd in charts/psmdb-operator-crds/templates/*.yaml; do
            cat "$crd" >> "$TEMP_COMBINED"
            echo "---" >> "$TEMP_COMBINED"
          done
          
          # Remove trailing separator if present
          if [ "$(tail -c 5 "$TEMP_COMBINED" | tr -d '\n')" = "---" ]; then
            truncate -s -5 "$TEMP_COMBINED"
            echo "" >> "$TEMP_COMBINED"
          fi
          
          # Normalize both files for comparison (remove trailing whitespace, normalize line endings)
          TEMP_CRDS=$(mktemp)
          TEMP_TEMPLATES=$(mktemp)
          
          cat charts/psmdb-operator/crds/crd.yaml | sed 's/[[:space:]]*$//' > "$TEMP_CRDS"
          cat "$TEMP_COMBINED" | sed 's/[[:space:]]*$//' > "$TEMP_TEMPLATES"
          
          # Compare files
          if diff -q "$TEMP_CRDS" "$TEMP_TEMPLATES" > /dev/null; then
            echo "✓ CRD files are in sync"
          else
            echo "✗ CRD files are NOT in sync!"
            echo ""
            echo "The files in charts/psmdb-operator/crds/crd.yaml and"
            echo "charts/psmdb-operator-crds/templates/*.yaml must match."
            echo ""
            echo "To sync them, run:"
            echo "  cat charts/psmdb-operator-crds/templates/*.yaml > charts/psmdb-operator/crds/crd.yaml"
            echo ""
            echo "Showing first 50 lines of differences:"
            diff -u "$TEMP_CRDS" "$TEMP_TEMPLATES" | head -50 || true
            exit 1
          fi
          
          rm -f "$TEMP_COMBINED" "$TEMP_CRDS" "$TEMP_TEMPLATES"

